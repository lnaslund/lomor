---
title: "3-get-hrt"
author: "L. Naslund"
date: "2024-06-17"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(mapview)
library(sf)
library(arcgis)

```

```{r}
# query NHD in 10km buffer 
url <- "https://hydro.nationalmap.gov/arcgis/rest/services/NHDPlus_HR/MapServer/5"

fl <- arc_open(url)

lomor_nhd <- arc_select(fl, filter_geom = lomor_10km %>% st_as_sfc())

# added discharge limit to make sure rivers are not routed to borrow pits
tribs <- lomor_nhd %>% mutate(reach_nm = if_else(is.na(gnis_name), "", gnis_name)) %>% filter(reach_nm != "Missouri River") %>% filter(qama < 10)

mapview(tribs)

nearest_flowlines <- st_nearest_feature(borrow, tribs)
```


```{r get discharge of nearest flowline to each borrow pit}

nearest_flowlines <- st_nearest_feature(borrow, tribs)

borrow$nearest <- nearest_flowlines
borrow$nearest_ID <- tribs %>% slice(nearest_flowlines) %>% pull(NHDPlusID)

# QAMA is originally in ft3/s convert to m3/d
# multiply by m3 in ft3 and s in d
borrow$nearest_QAMA <- tribs %>% slice(nearest_flowlines) %>% pull(QAMA) * 0.0283168 * 86400

borrow$area <- st_area(borrow) 

# going to have to figure out how to make sure it selects from the correct side of the river. May create a mask and do it one side at a time or hand edit. Also going to have to filter so that you aren't sending the Nishnabotna river through a tiny borrow pit
mapview(tribs %>% slice(nearest_flowlines))+mapview(borrow)
```